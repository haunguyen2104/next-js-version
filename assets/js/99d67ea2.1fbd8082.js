"use strict";(self.webpackChunknext_version=self.webpackChunknext_version||[]).push([[1102],{9755:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>l});var i=n(5893),s=n(1151);const a={description:"Next.js automatically traces which files are needed by each page to allow for easy deployment of your application. Learn how it works here."},o="Output File Tracing",r={id:"next-js/v13.0.0/advanced-features/output-file-tracing",title:"Output File Tracing",description:"Next.js automatically traces which files are needed by each page to allow for easy deployment of your application. Learn how it works here.",source:"@site/docs/next-js/v13.0.0/advanced-features/output-file-tracing.md",sourceDirName:"next-js/v13.0.0/advanced-features",slug:"/next-js/v13.0.0/advanced-features/output-file-tracing",permalink:"/next-js/v13.0.0/advanced-features/output-file-tracing",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/next-js/v13.0.0/advanced-features/output-file-tracing.md",tags:[],version:"current",frontMatter:{description:"Next.js automatically traces which files are needed by each page to allow for easy deployment of your application. Learn how it works here."},sidebar:"tutorialSidebar",previous:{title:"Multi Zones",permalink:"/next-js/v13.0.0/advanced-features/multi-zones"},next:{title:"Preview Mode",permalink:"/next-js/v13.0.0/advanced-features/preview-mode"}},c={},l=[{value:"How It Works",id:"how-it-works",level:2},{value:"Automatically Copying Traced Files",id:"automatically-copying-traced-files",level:2},{value:"Caveats",id:"caveats",level:2}];function d(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.h1,{id:"output-file-tracing",children:"Output File Tracing"}),"\n",(0,i.jsx)(t.p,{children:"During a build, Next.js will automatically trace each page and its dependencies to determine all of the files that are needed for deploying a production version of your application."}),"\n",(0,i.jsxs)(t.p,{children:["This feature helps reduce the size of deployments drastically. Previously, when deploying with Docker you would need to have all files from your package's ",(0,i.jsx)(t.code,{children:"dependencies"})," installed to run ",(0,i.jsx)(t.code,{children:"next start"}),". Starting with Next.js 12, you can leverage Output File Tracing in the ",(0,i.jsx)(t.code,{children:".next/"})," directory to only include the necessary files."]}),"\n",(0,i.jsxs)(t.p,{children:["Furthermore, this removes the need for the deprecated ",(0,i.jsx)(t.code,{children:"serverless"})," target which can cause various issues and also creates unnecessary duplication."]}),"\n",(0,i.jsx)(t.h2,{id:"how-it-works",children:"How It Works"}),"\n",(0,i.jsxs)(t.p,{children:["During ",(0,i.jsx)(t.code,{children:"next build"}),", Next.js will use ",(0,i.jsx)(t.a,{href:"https://github.com/vercel/nft",children:(0,i.jsx)(t.code,{children:"@vercel/nft"})})," to statically analyze ",(0,i.jsx)(t.code,{children:"import"}),", ",(0,i.jsx)(t.code,{children:"require"}),", and ",(0,i.jsx)(t.code,{children:"fs"})," usage to determine all files that a page might load."]}),"\n",(0,i.jsxs)(t.p,{children:["Next.js' production server is also traced for its needed files and output at ",(0,i.jsx)(t.code,{children:".next/next-server.js.nft.json"})," which can be leveraged in production."]}),"\n",(0,i.jsxs)(t.p,{children:["To leverage the ",(0,i.jsx)(t.code,{children:".nft.json"})," files emitted to the ",(0,i.jsx)(t.code,{children:".next"})," output directory, you can read the list of files in each trace that are relative to the ",(0,i.jsx)(t.code,{children:".nft.json"})," file and then copy them to your deployment location."]}),"\n",(0,i.jsx)(t.h2,{id:"automatically-copying-traced-files",children:"Automatically Copying Traced Files"}),"\n",(0,i.jsxs)(t.p,{children:["Next.js can automatically create a ",(0,i.jsx)(t.code,{children:"standalone"})," folder that copies only the necessary files for a production deployment including select files in ",(0,i.jsx)(t.code,{children:"node_modules"}),"."]}),"\n",(0,i.jsxs)(t.p,{children:["To leverage this automatic copying you can enable it in your ",(0,i.jsx)(t.code,{children:"next.config.js"}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-js",children:"module.exports = {\n  output: 'standalone',\n}\n"})}),"\n",(0,i.jsxs)(t.p,{children:["This will create a folder at ",(0,i.jsx)(t.code,{children:".next/standalone"})," which can then be deployed on its own without installing ",(0,i.jsx)(t.code,{children:"node_modules"}),"."]}),"\n",(0,i.jsxs)(t.p,{children:["Additionally, a minimal ",(0,i.jsx)(t.code,{children:"server.js"})," file is also output which can be used instead of ",(0,i.jsx)(t.code,{children:"next start"}),". This minimal server does not copy the ",(0,i.jsx)(t.code,{children:"public"})," or ",(0,i.jsx)(t.code,{children:".next/static"})," folders by default as these should ideally be handled by a CDN instead, although these folders can be copied to the ",(0,i.jsx)(t.code,{children:"standalone/public"})," and ",(0,i.jsx)(t.code,{children:"standalone/.next/static"})," folders manually, after which ",(0,i.jsx)(t.code,{children:"server.js"})," file will serve these automatically."]}),"\n",(0,i.jsxs)(t.p,{children:["Note: ",(0,i.jsx)(t.code,{children:"next.config.js"})," is read during ",(0,i.jsx)(t.code,{children:"next build"})," and serialized into the ",(0,i.jsx)(t.code,{children:"server.js"})," output file. If the legacy ",(0,i.jsxs)(t.a,{href:"/docs/api-reference/next.config.js/runtime-configuration.md",children:[(0,i.jsx)(t.code,{children:"serverRuntimeConfig"})," or ",(0,i.jsx)(t.code,{children:"publicRuntimeConfig"})," options"]})," are being used, the values will be specific to values at build time."]}),"\n",(0,i.jsxs)(t.p,{children:["If your project uses ",(0,i.jsx)(t.a,{href:"/docs/basic-features/image-optimization.md",children:"Image Optimization"})," with the default ",(0,i.jsx)(t.code,{children:"loader"}),", you must install ",(0,i.jsx)(t.code,{children:"sharp"})," as a dependency:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"npm i sharp\n"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"yarn add sharp\n"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"pnpm add sharp\n"})}),"\n",(0,i.jsx)(t.h2,{id:"caveats",children:"Caveats"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["While tracing in monorepo setups, the project directory is used for tracing by default. For ",(0,i.jsx)(t.code,{children:"next build packages/web-app"}),", ",(0,i.jsx)(t.code,{children:"packages/web-app"})," would be the tracing root and any files outside of that folder will not be included. To include files outside of this folder you can set ",(0,i.jsx)(t.code,{children:"experimental.outputFileTracingRoot"})," in your ",(0,i.jsx)(t.code,{children:"next.config.js"}),"."]}),"\n"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-js",children:"// packages/web-app/next.config.js\nmodule.exports = {\n  experimental: {\n    // this includes files from the monorepo base two directories up\n    outputFileTracingRoot: path.join(__dirname, '../../'),\n  },\n}\n"})}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["There are some cases in which Next.js might fail to include required files, or might incorrectly include unused files. In those cases, you can export page configs props ",(0,i.jsx)(t.code,{children:"unstable_includeFiles"})," and ",(0,i.jsx)(t.code,{children:"unstable_excludeFiles"})," respectively. Each prop accepts an array of ",(0,i.jsx)(t.a,{href:"https://www.npmjs.com/package/minimatch",children:"minimatch globs"})," relative to the project's root to either include or exclude in the trace."]}),"\n",(0,i.jsxs)(t.li,{children:["Currently, Next.js does not do anything with the emitted ",(0,i.jsx)(t.code,{children:".nft.json"})," files. The files must be read by your deployment platform, for example ",(0,i.jsx)(t.a,{href:"https://vercel.com",children:"Vercel"}),", to create a minimal deployment. In a future release, a new command is planned to utilize these ",(0,i.jsx)(t.code,{children:".nft.json"})," files."]}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,s.a)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},1151:(e,t,n)=>{n.d(t,{Z:()=>r,a:()=>o});var i=n(7294);const s={},a=i.createContext(s);function o(e){const t=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(a.Provider,{value:t},e.children)}}}]);