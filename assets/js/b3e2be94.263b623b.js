"use strict";(self.webpackChunknext_version=self.webpackChunknext_version||[]).push([[1758],{8719:(e,n,c)=>{c.r(n),c.d(n,{assets:()=>r,contentTitle:()=>a,default:()=>h,frontMatter:()=>t,metadata:()=>o,toc:()=>l});var i=c(5893),s=c(1151);const t={description:"Learn how to configure CI to cache Next.js builds"},a="Continuous Integration (CI) Build Caching",o={id:"next-js/v13.0.1/advanced-features/ci-build-caching",title:"Continuous Integration (CI) Build Caching",description:"Learn how to configure CI to cache Next.js builds",source:"@site/docs/next-js/v13.0.1/advanced-features/ci-build-caching.md",sourceDirName:"next-js/v13.0.1/advanced-features",slug:"/next-js/v13.0.1/advanced-features/ci-build-caching",permalink:"/next-js/v13.0.1/advanced-features/ci-build-caching",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/next-js/v13.0.1/advanced-features/ci-build-caching.md",tags:[],version:"current",frontMatter:{description:"Learn how to configure CI to cache Next.js builds"},sidebar:"tutorialSidebar",previous:{title:"Automatic Static Optimization",permalink:"/next-js/v13.0.1/advanced-features/automatic-static-optimization"},next:{title:"Next.js Codemods",permalink:"/next-js/v13.0.1/advanced-features/codemods"}},r={},l=[{value:"Vercel",id:"vercel",level:2},{value:"CircleCI",id:"circleci",level:2},{value:"Travis CI",id:"travis-ci",level:2},{value:"GitLab CI",id:"gitlab-ci",level:2},{value:"Netlify CI",id:"netlify-ci",level:2},{value:"AWS CodeBuild",id:"aws-codebuild",level:2},{value:"GitHub Actions",id:"github-actions",level:2},{value:"Bitbucket Pipelines",id:"bitbucket-pipelines",level:2},{value:"Heroku",id:"heroku",level:2},{value:"Azure Pipelines",id:"azure-pipelines",level:2}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",p:"p",pre:"pre",...(0,s.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"continuous-integration-ci-build-caching",children:"Continuous Integration (CI) Build Caching"}),"\n",(0,i.jsxs)(n.p,{children:["To improve build performance, Next.js saves a cache to ",(0,i.jsx)(n.code,{children:".next/cache"})," that is shared between builds."]}),"\n",(0,i.jsx)(n.p,{children:"To take advantage of this cache in Continuous Integration (CI) environments, your CI workflow will need to be configured to correctly persist the cache between builds."}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["If your CI is not configured to persist ",(0,i.jsx)(n.code,{children:".next/cache"})," between builds, you may see a ",(0,i.jsx)(n.a,{href:"https://nextjs.org/docs/messages/no-cache",children:"No Cache Detected"})," error."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Here are some example cache configurations for common CI providers:"}),"\n",(0,i.jsx)(n.h2,{id:"vercel",children:"Vercel"}),"\n",(0,i.jsx)(n.p,{children:"Next.js caching is automatically configured for you. There's no action required on your part."}),"\n",(0,i.jsx)(n.h2,{id:"circleci",children:"CircleCI"}),"\n",(0,i.jsxs)(n.p,{children:["Edit your ",(0,i.jsx)(n.code,{children:"save_cache"})," step in ",(0,i.jsx)(n.code,{children:".circleci/config.yml"})," to include ",(0,i.jsx)(n.code,{children:".next/cache"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'steps:\n  - save_cache:\n      key: dependency-cache-{{ checksum "yarn.lock" }}\n      paths:\n        - ./node_modules\n        - ./.next/cache\n'})}),"\n",(0,i.jsxs)(n.p,{children:["If you do not have a ",(0,i.jsx)(n.code,{children:"save_cache"})," key, please follow CircleCI's ",(0,i.jsx)(n.a,{href:"https://circleci.com/docs/2.0/caching/",children:"documentation on setting up build caching"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"travis-ci",children:"Travis CI"}),"\n",(0,i.jsxs)(n.p,{children:["Add or merge the following into your ",(0,i.jsx)(n.code,{children:".travis.yml"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"cache:\n  directories:\n    - $HOME/.cache/yarn\n    - node_modules\n    - .next/cache\n"})}),"\n",(0,i.jsx)(n.h2,{id:"gitlab-ci",children:"GitLab CI"}),"\n",(0,i.jsxs)(n.p,{children:["Add or merge the following into your ",(0,i.jsx)(n.code,{children:".gitlab-ci.yml"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"cache:\n  key: ${CI_COMMIT_REF_SLUG}\n  paths:\n    - node_modules/\n    - .next/cache/\n"})}),"\n",(0,i.jsx)(n.h2,{id:"netlify-ci",children:"Netlify CI"}),"\n",(0,i.jsxs)(n.p,{children:["Use ",(0,i.jsx)(n.a,{href:"https://www.netlify.com/products/build/plugins/",children:"Netlify Plugins"})," with ",(0,i.jsx)(n.a,{href:"https://www.npmjs.com/package/@netlify/plugin-nextjs",children:(0,i.jsx)(n.code,{children:"@netlify/plugin-nextjs"})}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"aws-codebuild",children:"AWS CodeBuild"}),"\n",(0,i.jsxs)(n.p,{children:["Add (or merge in) the following to your ",(0,i.jsx)(n.code,{children:"buildspec.yml"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"cache:\n  paths:\n    - 'node_modules/**/*' # Cache `node_modules` for faster `yarn` or `npm i`\n    - '.next/cache/**/*' # Cache Next.js for faster application rebuilds\n"})}),"\n",(0,i.jsx)(n.h2,{id:"github-actions",children:"GitHub Actions"}),"\n",(0,i.jsxs)(n.p,{children:["Using GitHub's ",(0,i.jsx)(n.a,{href:"https://github.com/actions/cache",children:"actions/cache"}),", add the following step in your workflow file:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"uses: actions/cache@v3\nwith:\n  # See here for caching with `yarn` https://github.com/actions/cache/blob/main/examples.md#node---yarn or you can leverage caching with actions/setup-node https://github.com/actions/setup-node\n  path: |\n    ~/.npm\n    ${{ github.workspace }}/.next/cache\n  # Generate a new cache whenever packages or source files change.\n  key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**.[jt]s', '**.[jt]sx') }}\n  # If source files changed but packages didn't, rebuild from a prior cache.\n  restore-keys: |\n    ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-\n"})}),"\n",(0,i.jsx)(n.h2,{id:"bitbucket-pipelines",children:"Bitbucket Pipelines"}),"\n",(0,i.jsxs)(n.p,{children:["Add or merge the following into your ",(0,i.jsx)(n.code,{children:"bitbucket-pipelines.yml"})," at the top level (same level as ",(0,i.jsx)(n.code,{children:"pipelines"}),"):"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"definitions:\n  caches:\n    nextcache: .next/cache\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Then reference it in the ",(0,i.jsx)(n.code,{children:"caches"})," section of your pipeline's ",(0,i.jsx)(n.code,{children:"step"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"- step:\n    name: your_step_name\n    caches:\n      - node\n      - nextcache\n"})}),"\n",(0,i.jsx)(n.h2,{id:"heroku",children:"Heroku"}),"\n",(0,i.jsxs)(n.p,{children:["Using Heroku's ",(0,i.jsx)(n.a,{href:"https://devcenter.heroku.com/articles/nodejs-support#custom-caching",children:"custom cache"}),", add a ",(0,i.jsx)(n.code,{children:"cacheDirectories"})," array in your top-level package.json:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:'"cacheDirectories": [".next/cache"]\n'})}),"\n",(0,i.jsx)(n.h2,{id:"azure-pipelines",children:"Azure Pipelines"}),"\n",(0,i.jsxs)(n.p,{children:["Using Azure Pipelines' ",(0,i.jsx)(n.a,{href:"https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/utility/cache",children:"Cache task"}),", add the following task to your pipeline yaml file somewhere prior to the task that executes ",(0,i.jsx)(n.code,{children:"next build"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"- task: Cache@2\n  displayName: 'Cache .next/cache'\n  inputs:\n    key: next | $(Agent.OS) | yarn.lock\n    path: '$(System.DefaultWorkingDirectory)/.next/cache'\n"})})]})}function h(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},1151:(e,n,c)=>{c.d(n,{Z:()=>o,a:()=>a});var i=c(7294);const s={},t=i.createContext(s);function a(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);