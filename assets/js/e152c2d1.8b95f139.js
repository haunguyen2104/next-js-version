"use strict";(self.webpackChunknext_version=self.webpackChunknext_version||[]).push([[4671],{8878:(e,s,r)=>{r.r(s),r.d(s,{assets:()=>c,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>a,toc:()=>l});var n=r(5893),t=r(1151);const o={description:"Start a Next.js app programmatically using a custom server."},i="Custom Server",a={id:"next-js/v13.0.1/advanced-features/custom-server",title:"Custom Server",description:"Start a Next.js app programmatically using a custom server.",source:"@site/docs/next-js/v13.0.1/advanced-features/custom-server.md",sourceDirName:"next-js/v13.0.1/advanced-features",slug:"/next-js/v13.0.1/advanced-features/custom-server",permalink:"/next-js/v13.0.1/advanced-features/custom-server",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/next-js/v13.0.1/advanced-features/custom-server.md",tags:[],version:"current",frontMatter:{description:"Start a Next.js app programmatically using a custom server."},sidebar:"tutorialSidebar",previous:{title:"Custom Error Page",permalink:"/next-js/v13.0.1/advanced-features/custom-error-page"},next:{title:"Customizing Babel Config",permalink:"/next-js/v13.0.1/advanced-features/customizing-babel-config"}},c={},l=[{value:"Disabling file-system routing",id:"disabling-file-system-routing",level:2}];function d(e){const s={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.a)(),...e.components},{Details:r}=s;return r||function(e,s){throw new Error("Expected "+(s?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(s.h1,{id:"custom-server",children:"Custom Server"}),"\n",(0,n.jsxs)(r,{children:[(0,n.jsx)("summary",{children:(0,n.jsx)("b",{children:"Examples"})}),(0,n.jsxs)("ul",{children:[(0,n.jsx)("li",{children:(0,n.jsx)("a",{href:"https://github.com/vercel/next.js/tree/canary/examples/custom-server-express",children:"Express integration"})}),(0,n.jsx)("li",{children:(0,n.jsx)("a",{href:"https://github.com/vercel/next.js/tree/canary/examples/custom-server-hapi",children:"Hapi integration"})}),(0,n.jsx)("li",{children:(0,n.jsx)("a",{href:"https://github.com/vercel/next.js/tree/canary/examples/custom-server-koa",children:"Koa integration"})}),(0,n.jsx)("li",{children:(0,n.jsx)("a",{href:"https://github.com/vercel/next.js/tree/canary/examples/ssr-caching",children:"SSR Caching"})})]})]}),"\n",(0,n.jsxs)(s.p,{children:["By default, Next.js includes its own server with ",(0,n.jsx)(s.code,{children:"next start"}),". If you have an existing backend, you can still use it with Next.js (this is not a custom server). A custom Next.js server allows you to start a server 100% programmatically in order to use custom server patterns. Most of the time, you will not need this \u2013 but it's available for complete customization."]}),"\n",(0,n.jsxs)(s.blockquote,{children:["\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"Note:"})," A custom server ",(0,n.jsx)(s.strong,{children:"cannot"})," be deployed on ",(0,n.jsx)(s.a,{href:"https://vercel.com/solutions/nextjs",children:"Vercel"}),"."]}),"\n"]}),"\n",(0,n.jsxs)(s.blockquote,{children:["\n",(0,n.jsxs)(s.p,{children:["Before deciding to use a custom server, please keep in mind that it should only be used when the integrated router of Next.js can't meet your app requirements. A custom server will remove important performance optimizations, like ",(0,n.jsx)(s.strong,{children:"serverless functions"})," and ",(0,n.jsxs)(s.strong,{children:[(0,n.jsx)(s.a,{href:"/docs/advanced-features/automatic-static-optimization.md",children:"Automatic Static Optimization"}),"."]})]}),"\n"]}),"\n",(0,n.jsx)(s.p,{children:"Take a look at the following example of a custom server:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-js",children:"// server.js\nconst { createServer } = require('http')\nconst { parse } = require('url')\nconst next = require('next')\n\nconst dev = process.env.NODE_ENV !== 'production'\nconst hostname = 'localhost'\nconst port = 3000\n// when using middleware `hostname` and `port` must be provided below\nconst app = next({ dev, hostname, port })\nconst handle = app.getRequestHandler()\n\napp.prepare().then(() => {\n  createServer(async (req, res) => {\n    try {\n      // Be sure to pass `true` as the second argument to `url.parse`.\n      // This tells it to parse the query portion of the URL.\n      const parsedUrl = parse(req.url, true)\n      const { pathname, query } = parsedUrl\n\n      if (pathname === '/a') {\n        await app.render(req, res, '/a', query)\n      } else if (pathname === '/b') {\n        await app.render(req, res, '/b', query)\n      } else {\n        await handle(req, res, parsedUrl)\n      }\n    } catch (err) {\n      console.error('Error occurred handling', req.url, err)\n      res.statusCode = 500\n      res.end('internal server error')\n    }\n  }).listen(port, (err) => {\n    if (err) throw err\n    console.log(`> Ready on http://${hostname}:${port}`)\n  })\n})\n"})}),"\n",(0,n.jsxs)(s.blockquote,{children:["\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.code,{children:"server.js"})," doesn't go through babel or webpack. Make sure the syntax and sources this file requires are compatible with the current node version you are running."]}),"\n"]}),"\n",(0,n.jsxs)(s.p,{children:["To run the custom server you'll need to update the ",(0,n.jsx)(s.code,{children:"scripts"})," in ",(0,n.jsx)(s.code,{children:"package.json"})," like so:"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-json",children:'"scripts": {\n  "dev": "node server.js",\n  "build": "next build",\n  "start": "NODE_ENV=production node server.js"\n}\n'})}),"\n",(0,n.jsx)(s.hr,{}),"\n",(0,n.jsx)(s.p,{children:"The custom server uses the following import to connect the server with the Next.js application:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-js",children:"const next = require('next')\nconst app = next({})\n"})}),"\n",(0,n.jsxs)(s.p,{children:["The above ",(0,n.jsx)(s.code,{children:"next"})," import is a function that receives an object with the following options:"]}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsxs)(s.li,{children:[(0,n.jsx)(s.code,{children:"dev"}),": ",(0,n.jsx)(s.code,{children:"Boolean"})," - Whether or not to launch Next.js in dev mode. Defaults to ",(0,n.jsx)(s.code,{children:"false"})]}),"\n",(0,n.jsxs)(s.li,{children:[(0,n.jsx)(s.code,{children:"dir"}),": ",(0,n.jsx)(s.code,{children:"String"})," - Location of the Next.js project. Defaults to ",(0,n.jsx)(s.code,{children:"'.'"})]}),"\n",(0,n.jsxs)(s.li,{children:[(0,n.jsx)(s.code,{children:"quiet"}),": ",(0,n.jsx)(s.code,{children:"Boolean"})," - Hide error messages containing server information. Defaults to ",(0,n.jsx)(s.code,{children:"false"})]}),"\n",(0,n.jsxs)(s.li,{children:[(0,n.jsx)(s.code,{children:"conf"}),": ",(0,n.jsx)(s.code,{children:"object"})," - The same object you would use in ",(0,n.jsx)(s.a,{href:"/docs/api-reference/next.config.js/introduction.md",children:"next.config.js"}),". Defaults to ",(0,n.jsx)(s.code,{children:"{}"})]}),"\n"]}),"\n",(0,n.jsxs)(s.p,{children:["The returned ",(0,n.jsx)(s.code,{children:"app"})," can then be used to let Next.js handle requests as required."]}),"\n",(0,n.jsx)(s.h2,{id:"disabling-file-system-routing",children:"Disabling file-system routing"}),"\n",(0,n.jsxs)(s.p,{children:["By default, ",(0,n.jsx)(s.code,{children:"Next"})," will serve each file in the ",(0,n.jsx)(s.code,{children:"pages"})," folder under a pathname matching the filename. If your project uses a custom server, this behavior may result in the same content being served from multiple paths, which can present problems with SEO and UX."]}),"\n",(0,n.jsxs)(s.p,{children:["To disable this behavior and prevent routing based on files in ",(0,n.jsx)(s.code,{children:"pages"}),", open ",(0,n.jsx)(s.code,{children:"next.config.js"})," and disable the ",(0,n.jsx)(s.code,{children:"useFileSystemPublicRoutes"})," config:"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-js",children:"module.exports = {\n  useFileSystemPublicRoutes: false,\n}\n"})}),"\n",(0,n.jsxs)(s.blockquote,{children:["\n",(0,n.jsxs)(s.p,{children:["Note that ",(0,n.jsx)(s.code,{children:"useFileSystemPublicRoutes"})," disables filename routes from SSR; client-side routing may still access those paths. When using this option, you should guard against navigation to routes you do not want programmatically."]}),"\n"]}),"\n",(0,n.jsxs)(s.blockquote,{children:["\n",(0,n.jsxs)(s.p,{children:["You may also wish to configure the client-side router to disallow client-side redirects to filename routes; for that refer to ",(0,n.jsx)(s.a,{href:"/docs/api-reference/next/router.md#router.beforePopState",children:(0,n.jsx)(s.code,{children:"router.beforePopState"})}),"."]}),"\n"]})]})}function u(e={}){const{wrapper:s}={...(0,t.a)(),...e.components};return s?(0,n.jsx)(s,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},1151:(e,s,r)=>{r.d(s,{Z:()=>a,a:()=>i});var n=r(7294);const t={},o=n.createContext(t);function i(e){const s=n.useContext(o);return n.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function a(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),n.createElement(o.Provider,{value:s},e.children)}}}]);