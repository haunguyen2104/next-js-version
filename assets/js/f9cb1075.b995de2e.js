"use strict";(self.webpackChunknext_version=self.webpackChunknext_version||[]).push([[9665],{5761:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>i,metadata:()=>d,toc:()=>a});var r=n(5893),t=n(1151);const i={description:"Learn how to use Middleware to run code before a request is completed."},o="Middleware",d={id:"next-js/v13.0.1/advanced-features/middleware",title:"Middleware",description:"Learn how to use Middleware to run code before a request is completed.",source:"@site/docs/next-js/v13.0.1/advanced-features/middleware.md",sourceDirName:"next-js/v13.0.1/advanced-features",slug:"/next-js/v13.0.1/advanced-features/middleware",permalink:"/next-js/v13.0.1/advanced-features/middleware",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/next-js/v13.0.1/advanced-features/middleware.md",tags:[],version:"current",frontMatter:{description:"Learn how to use Middleware to run code before a request is completed."},sidebar:"tutorialSidebar",previous:{title:"Measuring performance",permalink:"/next-js/v13.0.1/advanced-features/measuring-performance"},next:{title:"Absolute Imports and Module path aliases",permalink:"/next-js/v13.0.1/advanced-features/module-path-aliases"}},c={},a=[{value:"Using Middleware",id:"using-middleware",level:2},{value:"Matching Paths",id:"matching-paths",level:2},{value:"Matcher",id:"matcher",level:3},{value:"Conditional Statements",id:"conditional-statements",level:3},{value:"NextResponse",id:"nextresponse",level:2},{value:"Using Cookies",id:"using-cookies",level:2},{value:"Setting Headers",id:"setting-headers",level:2},{value:"Related",id:"related",level:2}];function l(e){const s={a:"a",blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.a)(),...e.components},{Details:n}=s;return n||function(e,s){throw new Error("Expected "+(s?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.h1,{id:"middleware",children:"Middleware"}),"\n",(0,r.jsxs)(n,{open:!0,children:[(0,r.jsx)("summary",{children:(0,r.jsx)("b",{children:"Version History"})}),(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Version"}),(0,r.jsx)(s.th,{children:"Changes"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"v13.0.0"})}),(0,r.jsx)(s.td,{children:"Support overriding request headers."})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"v12.2.0"})}),(0,r.jsx)(s.td,{children:"Middleware is stable"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"v12.0.9"})}),(0,r.jsxs)(s.td,{children:["Enforce absolute URLs in Edge Runtime (",(0,r.jsx)(s.a,{href:"https://github.com/vercel/next.js/pull/33410",children:"PR"}),")"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"v12.0.0"})}),(0,r.jsx)(s.td,{children:"Middleware (Beta) added"})]})]})]})]}),"\n",(0,r.jsx)(s.p,{children:"Middleware allows you to run code before a request is completed, then based on the incoming request, you can modify the response by rewriting, redirecting, adding headers, or setting cookies."}),"\n",(0,r.jsxs)(s.p,{children:["Middleware runs ",(0,r.jsx)(s.em,{children:"before"})," cached content, so you can personalize static files and pages. Common examples of Middleware would be authentication, A/B testing, localized pages, bot protection, and more. Regarding localized pages, you can start with ",(0,r.jsx)(s.a,{href:"/docs/advanced-features/i18n-routing",children:"i18n routing"})," and implement Middleware for more advanced use cases."]}),"\n",(0,r.jsxs)(s.blockquote,{children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Note:"})," If you were using Middleware prior to ",(0,r.jsx)(s.code,{children:"12.2"}),", please see the ",(0,r.jsx)(s.a,{href:"https://nextjs.org/docs/messages/middleware-upgrade-guide",children:"upgrade guide"}),"."]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"using-middleware",children:"Using Middleware"}),"\n",(0,r.jsx)(s.p,{children:"To begin using Middleware, follow the steps below:"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:"Install the latest version of Next.js:"}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"npm install next@latest\n"})}),"\n",(0,r.jsxs)(s.ol,{start:"2",children:["\n",(0,r.jsxs)(s.li,{children:["Create a ",(0,r.jsx)(s.code,{children:"middleware.ts"})," (or ",(0,r.jsx)(s.code,{children:".js"}),") file at the root or in the ",(0,r.jsx)(s.code,{children:"src"})," directory (same level as your ",(0,r.jsx)(s.code,{children:"pages"}),")"]}),"\n",(0,r.jsxs)(s.li,{children:["Export a middleware function from the ",(0,r.jsx)(s.code,{children:"middleware.ts"})," file:"]}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-typescript",children:"// middleware.ts\nimport { NextResponse } from 'next/server'\nimport type { NextRequest } from 'next/server'\n\n// This function can be marked `async` if using `await` inside\nexport function middleware(request: NextRequest) {\n  return NextResponse.redirect(new URL('/about-2', request.url))\n}\n\n// See \"Matching Paths\" below to learn more\nexport const config = {\n  matcher: '/about/:path*',\n}\n"})}),"\n",(0,r.jsx)(s.h2,{id:"matching-paths",children:"Matching Paths"}),"\n",(0,r.jsxs)(s.p,{children:["Middleware will be invoked for ",(0,r.jsx)(s.strong,{children:"every route in your project"}),". The following is the execution order:"]}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"headers"})," from ",(0,r.jsx)(s.code,{children:"next.config.js"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"redirects"})," from ",(0,r.jsx)(s.code,{children:"next.config.js"})]}),"\n",(0,r.jsxs)(s.li,{children:["Middleware (",(0,r.jsx)(s.code,{children:"rewrites"}),", ",(0,r.jsx)(s.code,{children:"redirects"}),", etc.)"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"beforeFiles"})," (",(0,r.jsx)(s.code,{children:"rewrites"}),") from ",(0,r.jsx)(s.code,{children:"next.config.js"})]}),"\n",(0,r.jsxs)(s.li,{children:["Filesystem routes (",(0,r.jsx)(s.code,{children:"public/"}),", ",(0,r.jsx)(s.code,{children:"_next/static/"}),", Pages, etc.)"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"afterFiles"})," (",(0,r.jsx)(s.code,{children:"rewrites"}),") from ",(0,r.jsx)(s.code,{children:"next.config.js"})]}),"\n",(0,r.jsxs)(s.li,{children:["Dynamic Routes (",(0,r.jsx)(s.code,{children:"/blog/[slug]"}),")"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"fallback"})," (",(0,r.jsx)(s.code,{children:"rewrites"}),") from ",(0,r.jsx)(s.code,{children:"next.config.js"})]}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"There are two ways to define which paths Middleware will run on:"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:"Custom matcher config"}),"\n",(0,r.jsx)(s.li,{children:"Conditional statements"}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"matcher",children:"Matcher"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"matcher"})," allows you to filter Middleware to run on specific paths."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-js",children:"export const config = {\n  matcher: '/about/:path*',\n}\n"})}),"\n",(0,r.jsx)(s.p,{children:"You can match a single path or multiple paths with an array syntax:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-js",children:"export const config = {\n  matcher: ['/about/:path*', '/dashboard/:path*'],\n}\n"})}),"\n",(0,r.jsxs)(s.p,{children:["The ",(0,r.jsx)(s.code,{children:"matcher"})," config allows full regex so matching like negative lookaheads or character matching is supported. An example of a negative lookahead to match all except specific paths can be seen here:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-js",children:"export const config = {\n  matcher: [\n    /*\n     * Match all request paths except for the ones starting with:\n     * - api (API routes)\n     * - static (static files)\n     * - favicon.ico (favicon file)\n     */\n    '/((?!api|static|favicon.ico).*)',\n  ],\n}\n"})}),"\n",(0,r.jsxs)(s.blockquote,{children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Note:"})," The ",(0,r.jsx)(s.code,{children:"matcher"})," values need to be constants so they can be statically analyzed at build-time. Dynamic values such as variables will be ignored."]}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"Configured matchers:"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["MUST start with ",(0,r.jsx)(s.code,{children:"/"})]}),"\n",(0,r.jsxs)(s.li,{children:["Can include named parameters: ",(0,r.jsx)(s.code,{children:"/about/:path"})," matches ",(0,r.jsx)(s.code,{children:"/about/a"})," and ",(0,r.jsx)(s.code,{children:"/about/b"})," but not ",(0,r.jsx)(s.code,{children:"/about/a/c"})]}),"\n",(0,r.jsxs)(s.li,{children:["Can have modifiers on named parameters (starting with ",(0,r.jsx)(s.code,{children:":"}),"): ",(0,r.jsx)(s.code,{children:"/about/:path*"})," matches ",(0,r.jsx)(s.code,{children:"/about/a/b/c"})," because ",(0,r.jsx)(s.code,{children:"*"})," is ",(0,r.jsx)(s.em,{children:"zero or more"}),". ",(0,r.jsx)(s.code,{children:"?"})," is ",(0,r.jsx)(s.em,{children:"zero or one"})," and ",(0,r.jsx)(s.code,{children:"+"})," ",(0,r.jsx)(s.em,{children:"one or more"})]}),"\n",(0,r.jsxs)(s.li,{children:["Can use regular expression enclosed in parenthesis: ",(0,r.jsx)(s.code,{children:"/about/(.*)"})," is the same as ",(0,r.jsx)(s.code,{children:"/about/:path*"})]}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:["Read more details on ",(0,r.jsx)(s.a,{href:"https://github.com/pillarjs/path-to-regexp#path-to-regexp-1",children:"path-to-regexp"})," documentation."]}),"\n",(0,r.jsxs)(s.blockquote,{children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Note:"})," For backward compatibility, Next.js always considers ",(0,r.jsx)(s.code,{children:"/public"})," as ",(0,r.jsx)(s.code,{children:"/public/index"}),". Therefore, a matcher of ",(0,r.jsx)(s.code,{children:"/public/:path"})," will match."]}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"conditional-statements",children:"Conditional Statements"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-typescript",children:"// middleware.ts\n\nimport { NextResponse } from 'next/server'\nimport type { NextRequest } from 'next/server'\n\nexport function middleware(request: NextRequest) {\n  if (request.nextUrl.pathname.startsWith('/about')) {\n    return NextResponse.rewrite(new URL('/about-2', request.url))\n  }\n\n  if (request.nextUrl.pathname.startsWith('/dashboard')) {\n    return NextResponse.rewrite(new URL('/dashboard/user', request.url))\n  }\n}\n"})}),"\n",(0,r.jsx)(s.h2,{id:"nextresponse",children:"NextResponse"}),"\n",(0,r.jsxs)(s.p,{children:["The ",(0,r.jsx)(s.a,{href:"#nextresponse",children:(0,r.jsx)(s.code,{children:"NextResponse"})})," API allows you to:"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"redirect"})," the incoming request to a different URL"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"rewrite"})," the response by displaying a given URL"]}),"\n",(0,r.jsxs)(s.li,{children:["Set request headers for API Routes, ",(0,r.jsx)(s.code,{children:"getServerSideProps"}),", and ",(0,r.jsx)(s.code,{children:"rewrite"})," destinations"]}),"\n",(0,r.jsx)(s.li,{children:"Set response cookies"}),"\n",(0,r.jsx)(s.li,{children:"Set response headers"}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:["To produce a response from Middleware, you should ",(0,r.jsx)(s.code,{children:"rewrite"})," to a route (",(0,r.jsx)(s.a,{href:"/docs/basic-features/pages.md",children:"Page"})," or ",(0,r.jsx)(s.a,{href:"/docs/api-routes/edge-api-routes.md",children:"Edge API Route"}),") that produces a response."]}),"\n",(0,r.jsx)(s.h2,{id:"using-cookies",children:"Using Cookies"}),"\n",(0,r.jsxs)(s.p,{children:["Cookies are regular headers. On a ",(0,r.jsx)(s.code,{children:"Request"}),", they are stored in the ",(0,r.jsx)(s.code,{children:"Cookie"})," header. On a ",(0,r.jsx)(s.code,{children:"Response"})," they are in the ",(0,r.jsx)(s.code,{children:"Set-Cookie"})," header. Next.js provides a convenient way to access and manipulate these cookies through the ",(0,r.jsx)(s.code,{children:"cookies"})," extension on ",(0,r.jsx)(s.code,{children:"NextRequest"})," and ",(0,r.jsx)(s.code,{children:"NextResponse"}),"."]}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["For incoming requests, ",(0,r.jsx)(s.code,{children:"cookies"})," comes with the following methods: ",(0,r.jsx)(s.code,{children:"get"}),", ",(0,r.jsx)(s.code,{children:"getAll"}),", ",(0,r.jsx)(s.code,{children:"set"}),", and ",(0,r.jsx)(s.code,{children:"delete"})," cookies. You can check for the existence of a cookie with ",(0,r.jsx)(s.code,{children:"has"})," or remove all cookies with ",(0,r.jsx)(s.code,{children:"clear"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:["For outgoing responses, ",(0,r.jsx)(s.code,{children:"cookies"})," have the following methods ",(0,r.jsx)(s.code,{children:"get"}),", ",(0,r.jsx)(s.code,{children:"getAll"}),", ",(0,r.jsx)(s.code,{children:"set"}),", and ",(0,r.jsx)(s.code,{children:"delete"}),"."]}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-typescript",children:"// middleware.ts\nimport { NextResponse } from 'next/server'\nimport type { NextRequest } from 'next/server'\n\nexport function middleware(request: NextRequest) {\n  // Assume a \"Cookie:vercel=fast\" header to be present on the incoming request\n  // Getting cookies from the request using the `RequestCookies` API\n  const cookie = request.cookies.get('nextjs')?.value\n  console.log(cookie) // => 'fast'\n  const allCookies = request.cookies.getAll()\n  console.log(allCookies) // => [{ name: 'vercel', value: 'fast' }]\n\n  request.cookies.has('nextjs') // => true\n  request.cookies.delete('nextjs')\n  request.cookies.has('nextjs') // => false\n\n  // Setting cookies on the response using the `ResponseCookies` API\n  const response = NextResponse.next()\n  response.cookies.set('vercel', 'fast')\n  response.cookies.set({\n    name: 'vercel',\n    value: 'fast',\n    path: '/test',\n  })\n  const cookie = response.cookies.get('vercel')\n  console.log(cookie) // => { name: 'vercel', value: 'fast', Path: '/test' }\n  // The outgoing response will have a `Set-Cookie:vercel=fast;path=/test` header.\n\n  return response\n}\n"})}),"\n",(0,r.jsx)(s.h2,{id:"setting-headers",children:"Setting Headers"}),"\n",(0,r.jsxs)(s.p,{children:["You can set request and response headers using the ",(0,r.jsx)(s.code,{children:"NextResponse"})," API (setting ",(0,r.jsx)(s.em,{children:"request"})," headers is available since Next.js v13.0.0)."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-ts",children:"// middleware.ts\n\nimport { NextResponse } from 'next/server'\nimport type { NextRequest } from 'next/server'\n\nexport function middleware(request: NextRequest) {\n  // Clone the request headers and set a new header `x-hello-from-middleware1`\n  const requestHeaders = new Headers(request.headers)\n  requestHeaders.set('x-hello-from-middleware1', 'hello')\n\n  // You can also set request headers in NextResponse.rewrite\n  const response = NextResponse.next({\n    request: {\n      // New request headers\n      headers: requestHeaders,\n    },\n  })\n\n  // Set a new response header `x-hello-from-middleware2`\n  response.headers.set('x-hello-from-middleware2', 'hello')\n  return response\n}\n"})}),"\n",(0,r.jsxs)(s.blockquote,{children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Note:"})," Avoid setting large headers as it might cause ",(0,r.jsx)(s.a,{href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/431",children:"431 Request Header Fields Too Large"})," error depending on your backend web server configuration."]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"related",children:"Related"}),"\n",(0,r.jsx)("div",{class:"card",children:(0,r.jsxs)("a",{href:"/docs/api-reference/edge-runtime.md",children:[(0,r.jsx)("b",{children:"Edge Runtime"}),(0,r.jsx)("small",{children:"Learn more about the supported Web APIs available."})]})}),"\n",(0,r.jsx)("div",{class:"card",children:(0,r.jsxs)("a",{href:"/docs/api-reference/next/server.md",children:[(0,r.jsx)("b",{children:"Middleware API Reference"}),(0,r.jsx)("small",{children:"Learn more about the supported APIs for Middleware."})]})}),"\n",(0,r.jsx)("div",{class:"card",children:(0,r.jsxs)("a",{href:"/docs/api-routes/edge-api-routes.md",children:[(0,r.jsx)("b",{children:"Edge API Routes"}),(0,r.jsx)("small",{children:"Build high performance APIs in Next.js. "})]})})]})}function h(e={}){const{wrapper:s}={...(0,t.a)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},1151:(e,s,n)=>{n.d(s,{Z:()=>d,a:()=>o});var r=n(7294);const t={},i=r.createContext(t);function o(e){const s=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function d(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),r.createElement(i.Provider,{value:s},e.children)}}}]);